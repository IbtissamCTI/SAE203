<?php
session_start();
if (!isset($_SESSION['user_role']) || $_SESSION['user_role'] != '2') { // Vérifie que l'utilisateur est un professeur
    header("Location: index.php");
    exit();
}

include 'config.php';

$pdo = connexionDB();

// Récupération des modules depuis la base de données
$stmt_modules = $pdo->query("SELECT * FROM Ressources")->fetchAll(PDO::FETCH_ASSOC);
$groupes = ['TPA', 'TPB', 'TPC', 'TPD', 'TPE', 'TPF'];
$types_evaluation = ['TP', 'SAE', 'PARTIEL', 'TD'];

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    if (isset($_POST['module'])) {
        $module_id = $_POST['module'];
        $coefficient = $_POST['coefficient'];
        $type = $_POST['type'];
        $libelle = $_POST['libelle'];
        $groupe = $_POST['groupe'];
        $date = date('Y-m-d H:i:s');

        // Insertion de l'évaluation
        $stmt_insert_evaluation = $pdo->prepare("INSERT INTO Evaluations (ress_id, coefficient, type, libelle, groupe, date) VALUES (?, ?, ?, ?, ?, ?)");
        $stmt_insert_evaluation->execute([$module_id, $coefficient, $type, $libelle, $groupe, $date]);
        $evaluation_id = $pdo->lastInsertId();

        // Récupération des étudiants du groupe sélectionné
        $stmt_etudiants = $pdo->prepare("SELECT * FROM Etudiants WHERE groupe = ?");
        $stmt_etudiants->execute([$groupe]);
        $etudiants = $stmt_etudiants->fetchAll(PDO::FETCH_ASSOC);

        // Enregistrement des notes
        foreach ($etudiants as $etudiant) {
            $note = $_POST['note_' . $etudiant['id']];
            $stmt_insert_note = $pdo->prepare("INSERT INTO Notes (evaluation_id, etudiant_id, note) VALUES (?, ?, ?)");
            $stmt_insert_note->execute([$evaluation_id, $etudiant['id'], $note]);
        }

        echo "Notes enregistrées avec succès";
    }
}
?>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ajouter des Notes</title>
    <link rel="stylesheet" href="../CSS/accueil_prof.css">
</head>
<body>
    <div class="header">
        <img src="../photo/logoblanc.png" alt="NoteNote Logo" class="logo">
        <button class="logout" onclick="location.href='index.php'">Quitter</button>
    </div>

    <div class="container">
        <button class="btn" onclick="location.href='ajout_notes.php'">Ajouter Notes</button>
        <button class="btn" onclick="location.href='liste_etudiants.php'">Acceder à la liste</button>
    </div>

    <div class="container">
        <h2>Enregistrer les notes</h2>
        <form action="ajout_notes.php" method="POST">
            <label for="module">Module:</label>
            <select name="module" id="module" required>
                <?php foreach ($stmt_modules as $module): ?>
                    <option value="<?= $module['id'] ?>"><?= $module['nom'] ?></option>
                <?php endforeach; ?>
            </select>

            <label for="coefficient">Coefficient:</label>
            <input type="number" name="coefficient" id="coefficient" step="0.1" required>

            <label for="type">Type d'évaluation:</label>
            <select name="type" id="type" required>
                <?php foreach ($types_evaluation as $type): ?>
                    <option value="<?= $type ?>"><?= $type ?></option>
                <?php endforeach; ?>
            </select>

            <label for="libelle">Libellé:</label>
            <input type="text" name="libelle" id="libelle" required>

            <label for="groupe">Groupe:</label>
            <select name="groupe" id="groupe" required>
                <?php foreach ($groupes as $groupe): ?>
                    <option value="<?= $groupe ?>"><?= $groupe ?></option>
                <?php endforeach; ?>
            </select>

            <button type="submit">Enregistrer les notes</button>
        </form>
    </div>

    <?php if (isset($etudiants)): ?>
        <div class="container">
            <h2>Entrer les notes pour le groupe <?= htmlspecialchars($groupe) ?></h2>
            <form action="ajout_notes.php" method="POST">
                <input type="hidden" name="module" value="<?= htmlspecialchars($module_id) ?>">
                <input type="hidden" name="coefficient" value="<?= htmlspecialchars($coefficient) ?>">
                <input type="hidden" name="type" value="<?= htmlspecialchars($type) ?>">
                <input type="hidden" name="libelle" value="<?= htmlspecialchars($libelle) ?>">
                <input type="hidden" name="groupe" value="<?= htmlspecialchars($groupe) ?>">

                <?php foreach ($etudiants as $etudiant): ?>
                    <label for="note_<?= $etudiant['id'] ?>"><?= htmlspecialchars($etudiant['nom']) ?>:</label>
                    <input type="number" name="note_<?= $etudiant['id'] ?>" id="note_<?= $etudiant['id'] ?>" step="0.1" min="0" max="20" required><br>
                <?php endforeach; ?>

                <button type="submit">Enregistrer les notes</button>
            </form>
        </div>
    <?php endif; ?>
</body>
</html>
